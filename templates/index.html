{% extends "base.html" %}

{% block title %}Barcode PDF Generator{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="text-center mb-5">
            <h2 class="mb-3">Barcode PDF Generator</h2>
            <p class="lead text-muted">Generate participant information sheets with barcodes.</p>
        </div>

        <form id="generateForm" action="/generate" method="POST" enctype="multipart/form-data">
            <div class="row g-4">
                <!-- Language Selection -->
                <div class="col-md-12">
                    <div class="card feature-card">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-globe text-primary me-2"></i>
                                Select Language
                            </h5>
                            <select class="form-select" id="languageSelect" name="language" required>
                                {% for lang in languages.keys() %}
                                <option value="{{ lang }}">{{ lang.upper() }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Template Selection -->
                <div class="col-md-12">
                    <div class="card feature-card">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-file-alt text-primary me-2"></i>
                                Choose Template
                            </h5>
                            <select class="form-select" id="templateSelect" name="template" required>
                                <!-- Populated by JavaScript -->
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Input Selection -->
                <div class="col-md-12">
                    <div class="card feature-card">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-barcode text-primary me-2"></i>
                                Barcode List
                            </h5>
                            <div class="mb-3">
                                <label class="form-label">Upload File (one ID per line, .txt only)</label>
                                <input type="file" class="form-control" name="barcode_file" id="barcodeFile" accept=".txt">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Or Paste IDs here</label>
                                <div class="input-group">
                                    <textarea class="form-control" name="barcodes" id="barcodeTextArea" rows="5" placeholder="ID001&#10;ID002&#10;..."></textarea>
                                </div>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-outline-info btn-sm" id="validateBtn">
                                        <i class="fas fa-check-circle me-1"></i>Validate Codes
                                    </button>
                                </div>
                            </div>
                            <div id="validationFeedback" class="mt-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Output Selection -->
                <div class="col-md-12">
                    <div class="card feature-card">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-folder-open text-primary me-2"></i>
                                Output Destination
                            </h5>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" name="just_download" value="true" id="justDownload">
                                <label class="form-check-label" for="justDownload">
                                    Just download as ZIP
                                </label>
                            </div>
                            <div id="folderSelectionSection">
                                <div class="mb-3">
                                    <label class="form-label">Choose Folder</label>
                                    <div class="input-group">
                                        <select class="form-select" name="output_folder" id="outputFolderSelect">
                                            {% for folder in output_folders %}
                                            <option value="{{ folder }}">{{ folder }}</option>
                                            {% endfor %}
                                        </select>
                                        <button class="btn btn-outline-secondary" type="button" id="newFolderBtn">New Folder</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Button -->
                <div class="col-md-12 text-center">
                    <button type="submit" class="btn btn-primary btn-lg px-5" id="generateBtn">
                        <i class="fas fa-cog fa-spin me-2 d-none" id="generateSpinner"></i>
                        Generate PDFs
                    </button>
                </div>

                <!-- Status Panel -->
                <div class="col-md-12 d-none" id="statusPanel">
                    <div class="card feature-card">
                        <div class="card-body">
                            <h5 class="card-title mb-3">Status</h5>
                            <div id="statusList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- New Folder Modal -->
<div class="modal fade" id="newFolderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Folder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" class="form-control" id="newFolderName" placeholder="Folder Name">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveFolderBtn">Create</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Language and template data from Jinja2
    const languagesData = {
        {% for lang, templates in languages.items() %}
        '{{ lang }}': [{% for template in templates %}'{{ template }}'{{ "," if not loop.last }}{% endfor %}],
        {% endfor %}
    };

    const languageSelect = document.getElementById('languageSelect');
    const templateSelect = document.getElementById('templateSelect');
    
    // Function to update template options based on selected language
    function updateTemplates() {
        const selectedLang = languageSelect.value;
        const templates = languagesData[selectedLang] || [];
        
        templateSelect.innerHTML = '';
        templates.forEach(template => {
            const option = document.createElement('option');
            option.value = template;
            option.textContent = template;
            templateSelect.appendChild(option);
        });
    }
    
    // Update templates on language change
    languageSelect.addEventListener('change', updateTemplates);
    
    // Initialize templates on page load
    updateTemplates();

    const form = document.getElementById('generateForm');
    const justDownload = document.getElementById('justDownload');
    const folderSection = document.getElementById('folderSelectionSection');
    const generateBtn = document.getElementById('generateBtn');
    const spinner = document.getElementById('generateSpinner');
    const statusPanel = document.getElementById('statusPanel');
    const statusList = document.getElementById('statusList');
    const barcodeTextArea = document.getElementById('barcodeTextArea');
    const barcodeFile = document.getElementById('barcodeFile');
    const validateBtn = document.getElementById('validateBtn');
    const validationFeedback = document.getElementById('validationFeedback');
    
    // Validation function
    function validateIDs(codeString) {
        if (!codeString.trim()) return { valid: true, errors: [], count: 0, codes: [] };
        
        const codes = codeString.split('\n').map(c => c.trim()).filter(c => c.length > 0);
        const errors = [];
        const seen = new Set();
        const validRegex = /^[a-zA-Z0-9_-]+$/; // Letters, numbers, underscore, dash
        
        codes.forEach((code, index) => {
            if (!validRegex.test(code)) {
                errors.push(`Line ${index + 1}: "${code}" contains invalid characters (no spaces, special chars, or Umlaute allowed).`);
            }
            if (seen.has(code)) {
                errors.push(`Line ${index + 1}: Duplicate ID "${code}" found.`);
            }
            seen.add(code);
        });
        
        return {
            valid: errors.length === 0,
            errors: errors,
                        count: codes.length,
                        codes: codes
        };
    }

        function openBarcodePreview(codes) {
                if (!codes || codes.length === 0) return;

                const preview = window.open('', '_blank', 'width=900,height=700');
                if (!preview) {
                        alert('Please allow pop-ups to see the barcode preview.');
                        return;
                }

                const html = `<!DOCTYPE html>
<html><head><title>Barcode Preview</title>
<style>
    body { font-family: system-ui, -apple-system, sans-serif; padding: 16px; }
    h3 { margin-bottom: 12px; }
    .item { display: flex; align-items: center; gap: 16px; margin-bottom: 16px; }
    .code-text { font-family: monospace; font-size: 14px; color: #333; }
    svg { border: 1px solid #e0e0e0; padding: 6px; background: #fafafa; }
</style>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"><\/script>
</head><body>
    <h3>Barcodes (${codes.length})</h3>
    <div id="barcodes"></div>
    <script>
        const codes = __CODES__;
        const container = document.getElementById('barcodes');
        codes.forEach(code => {
            const wrap = document.createElement('div');
            wrap.className = 'item';
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('jsbarcode-format', 'code128');
            svg.setAttribute('jsbarcode-value', code);
            svg.setAttribute('jsbarcode-height', '60');
            svg.setAttribute('jsbarcode-width', '1.6');
            svg.setAttribute('jsbarcode-display-value', 'true');
            svg.setAttribute('jsbarcode-margin', '6');
            const label = document.createElement('div');
            label.className = 'code-text';
            label.textContent = code;
            wrap.appendChild(svg);
            wrap.appendChild(label);
            container.appendChild(wrap);
            JsBarcode(svg).init();
        });
    <\/script>
</body></html>`;

                // Inject the actual codes into the placeholder array after creating the HTML
                const hydratedHtml = html.replace('__CODES__', JSON.stringify(codes));
                preview.document.write(hydratedHtml);
                preview.document.close();
        }

    function displayValidation(result) {
        validationFeedback.innerHTML = '';
        if (result.errors.length > 0) {
            validationFeedback.innerHTML = `
                <div class="alert alert-danger py-2 px-3 small">
                    <ul class="mb-0">
                        ${result.errors.map(err => `<li>${err}</li>`).join('')}
                    </ul>
                </div>`;
            return false;
        } else if (result.count > 0) {
            validationFeedback.innerHTML = `
                <div class="alert alert-success py-2 px-3 small mb-0">
                    <i class="fas fa-check-circle me-1"></i> ${result.count} codes validated successfully.
                </div>`;
            return true;
        }
        return true;
    }

    validateBtn.addEventListener('click', () => {
        const result = validateIDs(barcodeTextArea.value);
        if (displayValidation(result)) {
            openBarcodePreview(result.codes);
        }
    });

    barcodeFile.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
            const content = event.target.result;
            const result = validateIDs(content);
            if (!displayValidation(result)) {
                // Clear the file if invalid
                barcodeFile.value = '';
            } else {
                // Optionally fill the textarea with the content
                barcodeTextArea.value = content;
            }
        };
        reader.readAsText(file);
    });

    // Toggle folder selection based on download checkbox
    justDownload.addEventListener('change', () => {
        folderSection.style.display = justDownload.checked ? 'none' : 'block';
    });

    // Handle New Folder
    const newFolderBtn = document.getElementById('newFolderBtn');
    const newFolderModal = new bootstrap.Modal(document.getElementById('newFolderModal'));
    const saveFolderBtn = document.getElementById('saveFolderBtn');
    const newFolderNameInput = document.getElementById('newFolderName');
    const outputFolderSelect = document.getElementById('outputFolderSelect');

    newFolderBtn.addEventListener('click', () => {
        newFolderModal.show();
    });

    saveFolderBtn.addEventListener('click', async () => {
        const name = newFolderNameInput.value.trim();
        if (!name) return;

        const response = await fetch('/create_folder', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name })
        });
        const data = await response.json();
        
        if (data.success) {
            const option = document.createElement('option');
            option.value = name;
            option.text = name;
            option.selected = true;
            outputFolderSelect.add(option);
            newFolderModal.hide();
            newFolderNameInput.value = '';
        } else {
            alert('Error creating folder: ' + data.message);
        }
    });

    // Handle Form Submission
    form.addEventListener('submit', async (e) => {
        // Run validation before submit
        const result = validateIDs(barcodeTextArea.value);
        if (!displayValidation(result)) {
            e.preventDefault();
            alert('Please fix validation errors before generating PDFs.');
            return;
        }

        if (justDownload.checked) {
            // Let the browser handle standard file download
            return;
        }

        e.preventDefault();
        
        generateBtn.disabled = true;
        spinner.classList.remove('d-none');
        statusPanel.classList.remove('d-none');
        statusList.innerHTML = '<div class="text-info">Processing...</div>';

        const formData = new FormData(form);
        const response = await fetch('/generate', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();

        generateBtn.disabled = false;
        spinner.classList.add('d-none');

        if (data.success) {
            statusList.innerHTML = '';
            data.results.forEach(res => {
                const item = document.createElement('div');
                item.className = res.status === 'success' ? 'success-item' : 'error-item';
                item.innerHTML = `<strong>${res.id}:</strong> ${res.status === 'success' ? 'Generated' : res.message}`;
                statusList.appendChild(item);
            });
        } else {
            statusList.innerHTML = `<div class="error-item"><strong>Error:</strong> ${data.message}</div>`;
        }
    });
</script>
{% endblock %}
